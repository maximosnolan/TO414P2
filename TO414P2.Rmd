---
title: "Team 6 Project 2"
author: "Maximos Nolan, Gloria Stach, Jack Yu, Neo Li, Zihan Zeng"
date: '2022-10-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Dataset Introduction

Our dataset, "Hotel Booking Demand" is obtained from Kaggle (https://www.kaggle.com/datasets/jessemostipak/hotel-booking-demand?page=2) and contains booking information for a city hotel and a resort hotel. The following variables are recorded in the dataset.

- **Hotel**, H1 = Resort Hotel or H2 = City Hotel)
- **Is_canceled**, value indicating if the booking was canceled (1) or not (0)
- **Lead_time**, number of days that elapsed between the entering date of the booking into the PMS and the arrival date
- **Arrival_date_year**, year of arrival date
- **Arrival_date_month**, month of arrival date
- **Arrival_date_week_number**, week number of year for arrival date
- **Arrival_date_day_of_month**, day of arrival date
- **Stays_in_weekend_nights**, number of weekend nights (Saturday or Sunday) the guest stayed or booked to stay at the hotel
- **Stays_in_week_nights**, number of week nights (Monday to Friday) the guest stayed or booked to stay at the hotel
- **Adults**, number of adults
- **Children**, number of children
- **Babies**, number of babies
- **Meal**, type of meal booked
- **Country**, country of origin
- **Market_segment**, market segment designation
- **Distribution_channel**, booking distribution channel
- **Is_repeated_guest**, value indicating if the booking name was from a repeated guest (1) or not (0)
- **Previous_cancellations**, number of previous bookings that were cancelled by the customer prior to the current booking
- **Previous_bookings_not_canceled**, number of previous bookings not cancelled by the customer prior to the current booking
- **Reserved_room_type**, code of room type reserved
- **Assigned_room_type**, code for the type of room assigned to the booking
- **Booking_changes**, number of changes/amendments made to the booking from the moment the booking was entered on the PMS until the moment of check-in or cancellation
- **Deposit_type**, indication on if the customer made a deposit to guarantee the booking
- **Agent**, ID of the travel agency that made the booking
- **Company**, ID of the company/entity that made the booking or responsible for paying the booking
- **Days_in_waiting_list**, number of days the booking was in the waiting list before it was confirmed to the customer
- **Customer_type**, type of booking, assuming one of four categories: Contract, Group, Transient, and Transient-party
- **Adr**, average Daily Rate as defined by dividing the sum of all lodging transactions by the total number of staying nights
- **Required_car_parking_spaces**, number of car parking spaces required by the customer
- **Total_of_special_requests**, number of special requests made by the customer
- **Reservation_status**, reservation last status, assuming one of three categories: Canceled – booking was canceled by the customer; Check-Out – customer has checked in but already departed; No-Show – customer did not check-in and did inform the hotel of the reason why
- **Reservation_status_date**, date at which the last status was set


# Business Question

Monitoring the rate of cancellation is important for every hotel as it's related to its revenue. We know that customers have different willingness to pay when they book the hotels at different dates. When they book ahead of time, they are more price sensitive, and the hotels normally charge a normal price. But for the customers who arrive on the day of booking, they have more inelastic demand and thus are willing to pay more. Therefore, hotels would charge them a premium. In order to have rooms for these pay on the same day as arrival customers, hotel management needs to have rooms reserved for them or protection levels, similar to the concept of safety stock in supply chain management.

Cancellations is one important part of calculating the protection levels, as booking cancellations on the day of arrival means more rooms for customers who are willing to pay a premium. Thus hotels factor in the rate of cancellation in their planning. Now let's assume the hotel is operating with reserving just enough rooms to meet the pay on the same day as arrival demand. Then random cancellations would mess up the planning as the empty room will be unused. Thus the hotels would need to weight the benefit and cost of having cancellations, with the simplest approach being calculating an average percentage of cancellations among all customers. How can we improve this approach to have more confidence in the rooms planning process?

The business question is thus how can we construct a model to predict a customer's rate of cancellation and plan the protection level accordingly to maximize the operating profit?

To see the impact of cancellation, we have two scenarios:

- The customer is predicted to not cancel but actually has a cancellation: since the demand for premium price is already met, this additional empty room will be unoccupied, thus generating a loss equals to the normal price.

- The customer is predicted to cancel but does not cancel: since we expect the customer to cancel, we expect to have one additional room for the higher willingness to pay customer groups. But not the customer doesn't cancel, so we lose a prospect revenue of premium price - normal price.

Thus we can further refine our question to be, how can we construct a model to predict a customer's rate of cancellation and plan the protection level accordingly to minimize the revenue loss from cancellations and therefore maximize the operating profit?

# Load the required library
```{r}
library(gmodels)
library(caret)
library(neuralnet)
library(crosstable)
library(tidyverse)
library(class)
library(ggplot2)
library(dplyr)
library(C50)
```

# Load the required dataset
```{r}
# load data
hoteldata <- read.csv("hotel_bookings.csv")
# view data
summary(hoteldata)
str(hoteldata)
```

# Explore the dataset by visualization
**Through our life experience, we start by exploring some variables first that could potentially impact the cancellation rate**
```{r}
# Check the lead_time
hist(hoteldata$lead_time, main="Distribution of the lead time", xlab="Lead Time",col="darkmagenta",
freq=FALSE)
# Check the customers' arrival month
ggplot(hoteldata) + geom_bar(mapping = aes(x = "", fill = arrival_date_month)) + labs(x = NULL) + coord_polar(theta = "y") + ylab("Arrival Month")
# Check the reserved room type
ggplot(hoteldata) + geom_bar(mapping = aes(x = "", fill = reserved_room_type), width = 1) + labs(x = NULL) +  coord_polar(theta = "y")
# Check the customer type
ggplot(hoteldata) + geom_bar(mapping = aes(x = "", fill = customer_type), width = 1) + labs(x = NULL)
```

# Clean the dataset
```{r}
# check that data looks good
summary(hoteldata)
# remove column about reservation_status as it indicates if the reservation is cancelled
hoteldata <- hoteldata[,-31]
# remove duplicate columns that show the same data
hoteldata$company <- NULL
hoteldata$assigned_room_type <- NULL
hoteldata$distribution_channel <- NULL
hoteldata$reservation_status_date <- NULL
hoteldata$arrival_date_year <- as.factor(hoteldata$arrival_date_year)
hoteldata$arrival_date_week_number <- as.factor(hoteldata$arrival_date_week_number)
hoteldata$arrival_date_day_of_month <- as.factor(hoteldata$arrival_date_day_of_month)
hoteldata$required_car_parking_spaces <- as.factor(hoteldata$required_car_parking_spaces)
hoteldata$meal <- as.factor(hoteldata$meal)
hoteldata$reserved_room_type <- as.factor(hoteldata$reserved_room_type)
hoteldata$deposit_type <- as.factor(hoteldata$deposit_type)
hoteldata$customer_type <- as.factor(hoteldata$customer_type)
hoteldata$arrival_date_month <- as.factor(hoteldata$arrival_date_month)
hoteldata$agent <- NULL
hoteldata$country <- as.factor(hoteldata$country)
hoteldata$market_segment <- NULL
hoteldata$country <- NULL
# replace NAs with mean
hoteldata$lead_time = ifelse(is.na(hoteldata$lead_time), mean(hoteldata$lead_time, na.rm = TRUE), hoteldata$lead_time)
# create three dummy variable levels for lead_time
# we are doing this because based on personal experience with hotel booking, lead time probably has a nonlinear relationship with hotel cancellation
hoteldata$lead_time <- ifelse(hoteldata$lead_time <= 7, "Short",
                        ifelse(hoteldata$lead_time <= 60, "Moderate", "Long"))
hoteldata$lead_time <- as.factor(hoteldata$lead_time)
summary(hoteldata)
str(hoteldata)

# convert all factors into dummy variables using model.matrix for later knn analysis
hoteldata <- as.data.frame(model.matrix(~.-1,hoteldata))
str(hoteldata)

# normalize the data
normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}

hoteldata_norm <- as.data.frame(lapply(hoteldata, normalize))
str(hoteldata_norm)
```

# Correlation for Numeric Columns
**Check to make sure no numeric columns are not too correlated and also can be used to choose which variables to include in the model later.**
```{r}
hoteldata_numeric <- hoteldata[,sapply(hoteldata, is.numeric)]
round(cor(hoteldata_numeric),2)
```

# Logistic Regression Prediction
```{r}
library(gmodels)
library(caret)

set.seed(12345)
canceled = which(hoteldata_norm$is_canceled == 1)
notCanceled = which(hoteldata_norm$is_canceled == 0)
train_id1 = c(sample(canceled , size = trunc(0.5 * length(canceled ))),sample(notCanceled , size = trunc(0.5 * length(notCanceled ))))
# index <- c(sample(length(data)), 0.05*length(data))
# train <-data[train_id1, ]
train <- hoteldata_norm[train_id1, ]
test <- hoteldata_norm[-train_id1, ]
# test <-data[-train_id1, ]
canceled_lr <- glm(is_canceled ~ . - hotelResort.Hotel, data = train, family = "binomial")
summary(canceled_lr)
pred_lr <- predict(canceled_lr, test, type="response")
pred_lr <- ifelse(pred_lr <= 0.5, 0, 1)
CrossTable(x = test$is_canceled, y = pred_lr, prop.chisq=FALSE)
confusionMatrix(as.factor(test$is_canceled), as.factor(pred_lr), positive = "1")
```

**Summary**
From the cross table, we can find that there are rooms for us to improve the profitability because both scenarios mentioned above do happen frequently (9662 & 2540). From the hypothesis tests, we notice that the coefficients of variables below are statistically significant, thus we may focus on them in later model building and profit improvement plans.

**Variables that worth being focused**
lead_time; hotel; arrival_date_month; meal; previous_cancellations; customer_type; reserved_room_type.

# kNN Prediction
```{r}

```

# ANN Prediction
```{r}

```

# Decision Trees Prediction
```{r}
# building the decision trees model
canceled_dt <- C5.0(as.factor(is_canceled) ~ ., data = train)
canceled_dt
summary(canceled_dt)
plot(canceled_dt, subtree = 5)

# predict with the decision tree model
pred_dt <- predict(canceled_dt, test)

# evaluate the model performance 
CrossTable(x = test$is_canceled, y = pred_dt, prop.chisq=FALSE)
confusionMatrix(as.factor(test$is_canceled), as.factor(pred_dt), positive = "1")

# improve the model accuracy by adding more trials to the model
canceled_dt_boost <- C5.0(train[-3], as.factor(train$is_canceled),
                       trials = 100)
pred_dt_boost <- predict(canceled_dt_boost, test)
CrossTable(x = test$is_canceled, y = pred_dt_boost, prop.chisq=FALSE)
confusionMatrix(as.factor(test$is_canceled), as.factor(pred_dt_boost), positive = "1")
```

**Summary**
From the boosted model, we can see that the accuracy is 82.7%, with 7782 false negatives (people who are predicted to not cancel but actually cancels) and 2545 false positives (people who are predicted to cancel but actually don't cancel). 


# Naive Bayes Prediction
```{r}

```